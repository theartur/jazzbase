var jazzbase = require('jazzbase');

var http = require('http');
var url = require('url');

function jazzbaseServer(port) {
    http.createServer(function (req, res) {
        var clientIP = (function (req) {
            return req.headers['x-forwarded-for'] || 
                req.connection.remoteAddress || 
                req.socket.remoteAddress ||
                req.connection.socket.remoteAddress;
        })(req);

        res.writeHead(200, {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*'
        });

        var query = url.parse(req.url, true).query;

        var channel = query.channel;
        var key = query.key;
        var data = query.data;

        var out = '';

        var opSet = data && key && channel;
        var opGet = key && channel;

        if (opSet) {
            console.log(new Date() + " " + clientIP + " SET :: ", channel, key, data);
            try {
                data = JSON.parse(data);
            } catch(e) {}

            jazzbase(channel).set(key, data);

        } else if (opGet) {
            console.log(new Date() + " " + clientIP + " GET :: ", channel, key);
            out = JSON.stringify(jazzbase(channel).get(key));

        } else {
            res.end("error: invalid jazzbase request");
        }

        console.log(new Date() + " " + clientIP + " :: Response: " + out);
        res.end(out ? out+"" : "");

    }).listen(port);

    console.log("Listening on " + port + " ...");
}

module.exports = jazzbaseServer;