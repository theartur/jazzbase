var jazzbase = require("jazzbase");
var channel = jazzbase("stress");

var countBack = 0;
var cmp = {};
var limit = 10000;

var totalStress = limit;
while (totalStress--) {
    var rndKey = Math.random();
    var rndData = Math.random();
    
    cmp[rndKey] = rndData;
    
    console.log("SET", rndKey, rndData);
    channel.set(rndKey, rndData, addAnotherRnd(rndKey));
}

function addAnotherRnd(who) {
    return function (err) {
        countBack++;
        
        if (err) {
            console.log(" >>> ERROR: ", err);
        } else {
            console.log(countBack + " -- " + who + " written");
            
            channel.get(who, function (err, data) {
                console.log("~~ ", cmp[who], data, cmp[who] === data);
                if (cmp[who] === data) {
//                     console.log(countBack + " -- " + who + " IS CONSISTENT :) ");
                    console.log(".");
                } else {
                    throw new Error("INCONSISTENT DATA");
                    console.log(">>> ERROR: " + countBack + " -- " + who + " IS BROKEN :((( ");
                }
            });

            if (countBack >= limit) {
                console.log(" --- END --- ", Object.keys(cmp).length);
            }
        }
    };
}